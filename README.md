[æ–‡ç« æ˜é‡‘åœ°å€](https://juejin.im/post/5acabf5b6fb9a028c71ebb10)

-------2020.09.17 update----

å‰ä¸€æ®µæ—¶é—´ç½‘ç»œæ¡†æ¶ä¼˜åŒ–ï¼Œéšç€ä¸šåŠ¡æ¨¡å—å˜å¤æ‚ï¼Œå‘ç°ç°æœ‰Apiæ¥å£çš„æ–‡ä»¶å·²ç»æœ‰ä¸€åƒè¡Œå·¦å³ã€‚è¿«ä¸å¾—å·²åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šåšæ¨¡å—åŒºåˆ†ã€‚

å…·ä½“çš„æ‹†åˆ†å¯ä»¥åœ¨Demoä¸­æŸ¥çœ‹```å¤šä¸šåŠ¡æ¨¡å—çš„æ‹†åˆ†```æ–‡ä»¶å¤¹ï¼Œç½‘ç»œè¯·æ±‚çš„å°è£…éƒ¨åˆ†é€»è¾‘åŸºæœ¬ä¸å˜ã€‚



-------2020.03.07 update----

ç»è¿‡æˆ‘å‡ å¹´çš„é¡¹ç›®å®è·µï¼ŒHandyJSONåº“æ˜¯çœŸçš„é¦™ï¼ŒJSONè½¬æ¨¡å‹ï¼Œæ–¹ä¾¿ã€‚ ```ä½†æ˜¯æœ‰ä¸€ç‚¹ä¸å¾—ä¸æä¸€ä¸‹```,å°±æ˜¯HandyJSON ```ç¨³å®šæ€§```ç›¸å…³çš„ä¸€äº›é—®é¢˜â—ï¸â—ï¸â—ï¸ï¼ŒSwift5.0 çš„æ—¶å€™å‡ºè¿‡ä¸€ä¸ªæ³›å‹è§£æå¤±è´¥çš„bug,åæ¥ä¿®å¥½äº†ï¼ŒiOS13.4 beta çš„æ—¶å€™ç”±äºSwiftæ”¹åŠ¨åº•å±‚æºç  å¯¼è‡´HandyJSONå´©æºƒã€‚ å› ä¸ºè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å…¬å¸çš„é¡¹ç›®ä¸“é—¨å‘äº†ä¸€ä¸ªbug fixedç‰ˆæœ¬ã€‚   ä»ç¨³å®šæ€§çš„è§’åº¦å¯ä»¥ç”¨ä¸šç•Œæ¯”è¾ƒå¤šçš„SwiftJSON + Codable æˆ–è€…ObjectMapper æ¥åšJSONè½¬æ¨¡å‹ã€‚ 
æœ¬Demoå’Œæ–‡ç« ä¸­ç½‘ç»œæ¡†æ¶çš„è§£æå’Œå°è£…éƒ½æ¯”è¾ƒç¨³å®š  å¯ä»¥å°½æƒ…ä½¿ç”¨

------ 2019.11.24 update æ–°å¢äº†å¦å¤–ä¸€ç§å°è£…æ€è·¯ï¼Œå†™åœ¨æœ€åï¼Œä¸‹é¢çš„æ˜¯æ­£æ–‡ã€‚------


è¸©å‘è¸©äº†4å¤©æ€»ç®—æŠŠåŸºäºMoyaçš„ç½‘ç»œæ¡†æ¶æ­å»ºå®Œæ¯•

çœ‹ç½‘ä¸Šå…³äºMoyaçš„æ•™ç¨‹ä¸å¤ªå¤šï¼Œå¤§å¤šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿˜æœ‰ä¸€äº›å¹´ä¹…å¤±ä¿®ã€‚è¿™é‡Œä¸“é—¨è®²è®²å…³äºmoyaçš„æ­å»ºåŠå®¹æ˜“é‡åˆ°çš„ä¸€äº›å‘ã€‚


# é‡è¦çš„ä¸œè¥¿æ”¾åˆ°æœ€å‰é¢

#### 1.æœ€å¥½çš„æ•™ææ˜¯å®˜æ–¹æ–‡æ¡£å’ŒDemoï¼ŒMoyaæœ‰[ä¸­æ–‡æ–‡æ¡£](https://github.com/Moya/Moya/tree/master/docs_CN)ã€‚

#### 2.å°è¯•ä¸€äº›ä¸ä¸€æ ·çš„ä¸œè¥¿ä¼šè®©å¼€å‘æ›´æœ‰è¶£ã€‚

#### 3.å†™æ¡ˆä¾‹ä¸ç»™Demoä¸å¤ªå¥½å§ã€‚



# ä¸ºä»€ä¹ˆé€‰æ‹©moyaï¼š

   ä¸€å¼€å§‹ç½‘ç»œæ¡†æ¶çš„é€‰å‹æœ‰Alamofireå’ŒMoyaã€‚

Â   Alamofireå¯ä»¥è¯´æ˜¯Swiftç‰ˆæœ¬çš„AFNï¼Œå•ƒAFNçš„è€å•ƒäº†å‡ å¹´äº†ï¼ŒAFNçš„ç¡®åšå¤§ç²¾æ·±ï¼Œæœ‰å¾ˆå¤šå€¼å¾—å¼€å‘è€…å»å­¦æ ¡çš„åœ°æ–¹ã€‚ä½†å¼€å‘è¿™ä¹ˆå¤šå¹´ï¼ŒAFNå®åœ¨æ˜¯å•ƒä¸åŠ¨äº†ã€‚è¯•ç€å°è£…äº†ä¸€ä¸‹Alamofireã€‚æ„Ÿè§‰å’ŒAFNå°è£…å¤§åŒå°å¼‚ã€‚

 å’ŒæŠ€æœ¯ç¾¤é‡Œçš„ä¸€äº›å¤§ä½¬è®¨è®ºäº†ä¸€ä¸‹,å¤§å¤šæ•°ä¹Ÿæ˜¯æ¨èMoyaï¼Œè‡³äºèŠå¤©è®°å½•é‡Œé¢æåŠçš„ ***åŒ…å«?åœ°å€çš„é—®é¢˜*** æˆ‘ä»¬åœ¨ç¨åçš„å†…å®¹é‡Œå»è§£å†³ã€‚åæ¥å’¬å’¬ç‰™å°±å†³å®šä½¿ç”¨Moyaç”¨æ–°é¡¹ç›®çš„ç½‘ç»œæ¡†æ¶ã€‚


![image](http://upload-images.jianshu.io/upload_images/1724449-6cbaec8a9dd62115?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

# About Moya

å·²ç»æœ‰å¤§ç¥æŠŠMoyaçš„åŸºæœ¬ä½¿ç”¨å’Œå„ä¸ªæ¨¡å—çš„ä»‹ç»è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå»ºè®®æŠŠæ¡†æ¶çš„åŸºæœ¬ä½¿ç”¨äº†è§£ä¸€ç•ª[ã€iOSå¼€å‘ã€‘Moyaå…¥å‘è®°-ç”¨æ³•è§£è¯»ç¯‡](https://www.jianshu.com/p/38fbc22a1e2b)Â Â 

ä¸Šæ–‡ä½œä¸ºå…¥é—¨æ˜¯ä¸€ç¯‡ä¸é”™çš„æ–‡ç« ï¼Œä½†ä½œä¸ºå®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¥å£®å…¨æ–¹ä½è€ƒè™‘çš„ç½‘ç»œæ¡†æ¶æ¥è¯´çš„æ¥è¯´è¿˜æœ‰å¾ˆå¤šç”¨æ³•å¹¶æ²¡æœ‰æåŠã€‚ è€Œä¸”ç½‘ä¸Šå¾ˆå¤šæ–‡ç« éƒ½æ˜¯è€ç‰ˆæœ¬ï¼Œçœ‹çš„æ—¶å€™ä¼šæ„Ÿè§‰æœ‰äº›æ‡µã€‚ã€‚ã€‚æ‰€ä»¥æˆ‘å°±å†™äº†æœ¬æ–‡ğŸ˜‘

# **Let's Begin**


#### **å°è£…çš„ç›®å½•ç»“æ„**

å®‰è£…å¥½Moyaåæˆ‘ä»¬ **åˆ›å»ºå¥½ä¸‰ä¸ªç©ºçš„Swiftæ–‡ä»¶** 

![image](http://upload-images.jianshu.io/upload_images/1724449-1632f5a42d3c9ea1?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æˆ‘ä»¬å¤§è‡´å¯å°†ç½‘ç»œæ¡†æ¶æ‹†åˆ†æˆ

 ***API.swift*** ---å°†æ¥æˆ‘ä»¬çš„æ¥å£åˆ—è¡¨å’Œä¸åŒçš„æ¥å£çš„ä¸€äº›é…ç½®åœ¨é‡Œé¢å®Œæˆï¼Œæœ€é•¿æ‰“äº¤é“çš„åœ°æ–¹ã€‚

 ***NetworkManager.swift*** ---åŸºæœ¬æ¡†æ¶é…ç½®åŠå°è£…å†™åˆ°è¿™é‡Œ

 ***MoyaConfig.swift*** ---è¿™ä¸ªå…¶å®å¯æœ‰å¯æ— çš„ï¼Œä¹ æƒ¯ä¸ŠæŠŠbaseURLå’Œä¸€äº›å…¬ç”¨å­—ç¬¦ä¸²æ”¾è¿›æ¥

OKæˆ‘ä»¬æ­£å¼å¼€å§‹codingï¼

API.swiftä¸­å…ˆåˆ›å»ºä¸€ä¸ªAPIçš„æšä¸¾ï¼Œæšä¸¾å€¼æ˜¯æ¥å£åï¼Œ å¹¶åˆ›å»ºéµå®ˆTargetTypeåè®®çš„extentionã€‚

è¿™é‡Œæˆ‘å†™ä¸‰ä¸ªæµ‹è¯•çš„Apiã€‚ç¬¬ä¸€ä¸ªæ˜¯æ— å‚ï¼Œç¬¬äºŒä¸ªæ˜¯æ™®é€šå†™æ³•(æˆ‘çœ‹å®˜æ–¹æ–‡æ¡£å¥½åƒæ˜¯è¿™ç§ ***å¤šå‚æ•°*** éƒ½å†™è¿›å»çš„ï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­æ„Ÿè§‰æœ‰äº›éº»çƒ¦)ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ç›´æ¥æŠŠæ‰€æœ‰å‚æ•°åŒ…è£…æˆå­—å…¸ä¼ è¿›æ¥çš„æ–‡è‰ºå†™æ³•ã€‚ã€‚

![image](http://upload-images.jianshu.io/upload_images/1724449-56416a46e74e8f54?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç›´æ¥ç‚¹å‡» **é”™è¯¯ä»£ç è¡¥å…¨** å³å¯è‡ªåŠ¨è¡¥å…¨æ‰€æœ‰çš„åè®®

```swift
import Foundation
import Moya

enum API {
    case testApi//æ— å‚æ•°çš„æ¥å£
    //æœ‰å‚æ•°çš„æ¥å£
    case testAPi(para1:String,para2:String)//æ™®éçš„å†™æ³•
    case testApiDict(Dict:[String:Any])//æŠŠå‚æ•°åŒ…è£…æˆå­—å…¸ä¼ å…¥--æ¨èä½¿ç”¨
}

extension API:TargetType{
    
    //baseURL ä¹Ÿå¯ä»¥ç”¨æšä¸¾æ¥åŒºåˆ†ä¸åŒçš„baseURLï¼Œä¸è¿‡ä¸€èˆ¬ä¹Ÿåªæœ‰ä¸€ä¸ªBaseURL
    var baseURL: URL {
        return URL.init(string: "http://news-at.zhihu.com/api/")!
    }
    //ä¸åŒæ¥å£çš„å­—è·¯å¾„
    var path: String {
        switch self {
        case .testApi:
            return "4/news/latest"
        case .testAPi(let para1, _):
            return "\(para1)/news/latest"
        case .testApiDict:
            return "4/news/latest"
//        default:
//            return "4/news/latest"
        }
    }
    
    /// è¯·æ±‚æ–¹å¼ get post put delete
    var method: Moya.Method {
        switch self {
        case .testApi:
            return .get
        default:
            return .post
        }
    }
    
    /// è¿™ä¸ªæ˜¯åšå•å…ƒæµ‹è¯•æ¨¡æ‹Ÿçš„æ•°æ®ï¼Œå¿…é¡»è¦å®ç°ï¼Œåªåœ¨å•å…ƒæµ‹è¯•æ–‡ä»¶ä¸­æœ‰ä½œç”¨
    var sampleData: Data {
        return "".data(using: String.Encoding.utf8)!
    }
    
    /// è¿™ä¸ªå°±æ˜¯APIé‡Œé¢çš„æ ¸å¿ƒã€‚å—¯ã€‚ã€‚è‡³å°‘æˆ‘è®¤ä¸ºæ˜¯æ ¸å¿ƒï¼Œå› ä¸ºæˆ‘å°±è¢«è¿™ä¸ªå‘è¿‡
    //ç±»ä¼¼ç†è§£ä¸ºAFNé‡Œçš„URLRequest
    var task: Task {
        switch self {
        case .testApi:
            return .requestPlain
        case let .testAPi(para1, _)://è¿™é‡Œçš„ç¼ºç‚¹å°±æ˜¯å¤šä¸ªå‚æ•°ä¼šå¯¼è‡´parametersæ‹¼æ¥è¿‡é•¿
        //åå°çš„content-Type ä¸ºapplication/x-www-form-urlencodedæ—¶é€‰æ‹©URLEncoding            
            return .requestParameters(parameters: ["key":para1], encoding: URLEncoding.default)
        case let .testApiDict(dict)://æ‰€æœ‰å‚æ•°å½“ä¸€ä¸ªå­—å…¸è¿›æ¥å®Œäº‹ã€‚
            //åå°å¯ä»¥æ¥æ”¶jsonå­—ç¬¦ä¸²åšå‚æ•°æ—¶é€‰è¿™ä¸ª
            return .requestParameters(parameters: dict, encoding: JSONEncoding.default)

        }
    }
    
    /// è®¾ç½®è¯·æ±‚å¤´header
    var headers: [String : String]? {
        //åŒtaskï¼Œå…·ä½“é€‰æ‹©çœ‹åå° æœ‰application/x-www-form-urlencoded ã€application/json
        return ["Content-Type":"application/x-www-form-urlencoded"]
    }
}
```

ä¸Šé¢api.swiftè®¾ç½®å®Œæ¯•


### NetworkManager.swift

ä¸‹é¢å°±å¼€å§‹æ„å»ºæˆ‘ä»¬çš„è¯·æ±‚ç›¸å…³çš„ä¸œè¥¿
ä¸»è¦æ˜¯å®Œæˆå¯¹äºProviderçš„å®Œå–„åŠä¸ªæ€§åŒ–è®¾ç½®ã€‚

é¦–å…ˆå…ˆçœ‹ä¸€ä¸ªæœ€ç®€å•çš„ç½‘ç»œè¯·æ±‚, æˆ‘ä»¬æ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯æ¥è‡ªäºè¿™ä¸ªproviderå¯¹è±¡ï¼Œæµ‹è¯•ä¸€ä¸‹ æˆ‘ä»¬å°±èƒ½å‘å‡ºè¯·æ±‚å¹¶æ‹¿åˆ°è¿”å›çš„ç»“æœã€‚

##### æ³¨ï¼š åœ¨2020.09.17ä¸‹è½½çš„Demoä¸­ provier çš„å¯¹è±¡çš„åˆ›å»º```MoyaProvider<API>```å·²ç»æ›¿æ¢æˆäº†```MoyaProvider<MultiTarget(å¯¹å¤šä¸šåŠ¡APIæƒ…å†µçš„å°è£…)>```åŒ…è£…å¥½çš„æšä¸¾ä½“ï¼Œç”¨ä»¥å¤šä¸šåŠ¡çš„æ‹†åˆ†ã€‚ å…·ä½“å¯å‚è€ƒdemo.  


```swift
        let provier = MoyaProvider<API>()
        provier.request(.testApi) { (result) in
            switch result {
            case let .success(response):
                print(response)
            case let .failure(error):
                    print("ç½‘ç»œè¿æ¥å¤±è´¥")
                    break
            }
        }
```

å½“ç„¶ï¼Œå¯¹åº”æƒ…å†µå¤æ‚çš„é¡¹ç›®è¿™ä¸ªæ˜¯ ***è¿œè¿œä¸å¤Ÿæ»´ï¼***

so~ ä¸‹é¢å¼€å§‹å¯¹providerè¿›è¡Œæ”¹é€ 

å…ˆçœ‹çœ‹æœ€ä¸°æ»¡çš„provideræ˜¯ä»€ä¹ˆæ ·å­çš„
![image.png](https://upload-images.jianshu.io/upload_images/1724449-848eb746a18c03a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å½“æˆ‘çœ‹åˆ°è¿™ä¸€ä¸ªä¸ªæ‰‘æœ”è¿·ç¦»çš„å‚æ•°æ—¶æˆ‘çš„è¡¨æƒ…æ˜¯è¿™æ ·çš„(âŠ™ï¹âŠ™)b

![image.png](https://upload-images.jianshu.io/upload_images/1724449-08ec60bb78118fc9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç‚¹è¿›å»çœ‹æºç æ‰å‘ç°Moyaå·²ç»å¸®æˆ‘ä»¬æŠŠæ¯ä¸ªå‚æ•°éƒ½é»˜è®¤å®ç°äº†ä¸€éã€‚***æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„è®¾è®¡éœ€æ±‚è®¾ç½®å‚æ•°***
æ¯ä¸ªå‚æ•°ä»€ä¹ˆæ„æ€ä¹Ÿä¸èµ˜è¿°äº†ï¼Œ[Moya çš„åˆå§‹åŒ–](https://www.jianshu.com/p/7286503db415)Â Â è¿™ç¯‡æ–‡ç« ä¹Ÿéƒ½è¯´äº†ã€‚

#### ä¸Šæ–‡éœ€è¦æŒ‡æ­£çš„åœ°æ–¹æ˜¯ï¼š

![image.png](https://upload-images.jianshu.io/upload_images/1724449-0f482299295f6d84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æ–‡ä¸­ endpointClosure çš„ä½¿ç”¨ä¸¾ä¾‹ä¸­ target.parameters å·²ç»æ²¡æœ‰è¿™ä¸ªå±æ€§äº†ã€‚ç°åœ¨ç‰ˆæœ¬çš„Moyaç”¨çš„taskä»£æ›¿çš„ã€‚
Moyaå®˜æ–¹ä¸å¸Œæœ›åœ¨æ‰€æœ‰çš„è¯·æ±‚ä¸­ç»Ÿä¸€æ·»åŠ å‚æ•°ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥è‡ªå·±å»å®šä¹‰endPointClosureå®ç°ç›¸åº”çš„æ•ˆæœ 
è¯¦æƒ…å‚ç…§ï¼š[Add additional parameters to all requests](https://github.com/Moya/Moya/issues/1482) é‡Œé¢æœ‰å…·ä½“çš„è§£å†³æ–¹æ¡ˆã€‚


#### æ ¹æ®å®é™…é¡¹ç›®éœ€æ±‚å»é™¤äº†ä¸å¤ªå¸¸ç”¨çš„ ***stubClosure*** ,   ***callbackQueue*** ,  ***trackInflights*** åæˆ‘çš„Provideré•¿è¿™æ ·

```swift
let Provider = MoyaProvider<API>(endpointClosure: myEndpointClosure, requestClosure: requestClosure, plugins: [networkPlugin], trackInflights: false)

```

ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹åŠ¨æ‰‹æ„å»ºæˆ‘ä»¬çš„networkManager

```swift
import Foundation
import Moya
import Alamofire
import SwiftyJSON

/// è¶…æ—¶æ—¶é•¿
private var requestTimeOut:Double = 30
///endpointClosure
private let myEndpointClosure = { (target: API) -> Endpoint in
///è¿™é‡Œçš„endpointClosureå’Œç½‘ä¸Šå…¶ä»–å®ç°æœ‰äº›ä¸å¤ªä¸€æ ·ã€‚
///ä¸»è¦æ˜¯ä¸ºäº†è§£å†³URLå¸¦æœ‰ï¼Ÿæ— æ³•è¯·æ±‚æ­£ç¡®çš„é“¾æ¥åœ°å€çš„bug
    let url = target.baseURL.absoluteString + target.path
    var endpoint = Endpoint(
        url: url,
        sampleResponseClosure: { .networkResponse(200, target.sampleData) },
        method: target.method,
        task: target.task,
        httpHeaderFields: target.headers
    )
    switch target {
    case .easyRequset:
        return endpoint
    case .register:
        requestTimeOut = 5//æŒ‰ç…§é¡¹ç›®éœ€æ±‚é’ˆå¯¹å•ä¸ªAPIè®¾ç½®ä¸åŒçš„è¶…æ—¶æ—¶é•¿
        return endpoint
    default:
        requestTimeOut = 30//è®¾ç½®é»˜è®¤çš„è¶…æ—¶æ—¶é•¿
        return endpoint
    }
}

private let requestClosure = { (endpoint: Endpoint, done: MoyaProvider.RequestResultClosure) in
    do {
        var request = try endpoint.urlRequest()
        //è®¾ç½®è¯·æ±‚æ—¶é•¿
        request.timeoutInterval = requestTimeOut
        // æ‰“å°è¯·æ±‚å‚æ•°
        if let requestData = request.httpBody {
            print("\(request.url!)"+"\n"+"\(request.httpMethod ?? "")"+"å‘é€å‚æ•°"+"\(String(data: request.httpBody!, encoding: String.Encoding.utf8) ?? "")")
        }else{
            print("\(request.url!)"+"\(String(describing: request.httpMethod))")
        }
        done(.success(request))
    } catch {
        done(.failure(MoyaError.underlying(error, nil)))
    }
}

/*   è®¾ç½®ssl
let policies: [String: ServerTrustPolicy] = [
    "example.com": .pinPublicKeys(
        publicKeys: ServerTrustPolicy.publicKeysInBundle(),
        validateCertificateChain: true,
        validateHost: true
    )
]
*/

// ç”¨Moyaé»˜è®¤çš„Managerè¿˜æ˜¯Alamofireçš„Managerçœ‹å®é™…éœ€æ±‚ã€‚HTTPSå°±è¦æ‰‹åŠ¨å®ç°Manageräº†
//private public func defaultAlamofireManager() -> Manager {
//    
//    let configuration = URLSessionConfiguration.default
//    
//    configuration.httpAdditionalHeaders = Alamofire.SessionManager.defaultHTTPHeaders
//    
//    let policies: [String: ServerTrustPolicy] = [
//        "ap.grtstar.cn": .disableEvaluation
//    ]
//    let manager = Alamofire.SessionManager(configuration: configuration,serverTrustPolicyManager: ServerTrustPolicyManager(policies: policies))
//    
//    manager.startRequestsImmediately = false
//    
//    return manager
//}


/// NetworkActivityPluginæ’ä»¶ç”¨æ¥ç›‘å¬ç½‘ç»œè¯·æ±‚
private let networkPlugin = NetworkActivityPlugin.init { (changeType, targetType) in

    print("networkPlugin \(changeType)")
    //targetType æ˜¯å½“å‰è¯·æ±‚çš„åŸºæœ¬ä¿¡æ¯
    switch(changeType){
    case .began:
        print("å¼€å§‹è¯·æ±‚ç½‘ç»œ")
        
    case .ended:
        print("ç»“æŸ")
    }
}

// https://github.com/Moya/Moya/blob/master/docs/Providers.md  å‚æ•°ä½¿ç”¨è¯´æ˜
//stubClosure   ç”¨æ¥å»¶æ—¶å‘é€ç½‘ç»œè¯·æ±‚

let Provider = MoyaProvider<API>(endpointClosure: myEndpointClosure, requestClosure: requestClosure, plugins: [networkPlugin], trackInflights: false)
```



### NetworkManager.swift åŸºæœ¬å†™å®Œ  è¿˜å‰©ä¸€ç‚¹ä¸‹é¢å†è¯´ã€‚
è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚å°±ä¼šé•¿è¿™æ ·ï¼š

```swift
        Provider.request(.testApi) { (result) in
            switch result {
            case let .success(response):
                print(response)
                //åšç›¸åº”çš„æ•°æ®å¤„ç†  è¿™é‡Œæˆ‘ç”¨çš„æ˜¯HandyJson
            case let .failure(error):
                print("ç½‘ç»œè¿æ¥å¤±è´¥")
                //æç¤ºç”¨æˆ·ç½‘ç»œé“¾æ¥å¤±è´¥
                break
            }
        }
```



### åƒæˆ‘è¿™ç§æ‡’å¾—ä¸€æ¯”çš„å¼€å‘è€…ï¼Œå½“ç„¶ä¸æƒ³æ¯ä¸€æ¬¡éƒ½å†™è¿™ä¹ˆå¤šresultåˆ¤æ–­ã€‚å†™å¥½å¤šé‡å¤çš„ä»£ç ã€‚

![image.png](https://upload-images.jianshu.io/upload_images/1724449-d983e7464f41bf69.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### äºæ˜¯æˆ‘å†³å®šå†æ¬¡å°è£…ã€‚ã€‚ã€‚

æ¥æ¥ï¼Œæˆ‘ä»¬å†æ¬¡å›åˆ°NetworkManager.swift å°è£…providerè¯·æ±‚ã€‚

## æ€è·¯ï¼š

1.åå°è¿”å›é”™è¯¯çš„æ—¶å€™æˆ‘ç»Ÿä¸€æŠŠerror msgæ˜¾ç¤ºç»™ç”¨æˆ·

2.åªæœ‰è¿”å›æ­£ç¡®çš„æ—¶å€™æ‰æŠŠæ•°æ®æå–å‡ºæ¥è¿›è¡Œè§£æã€‚ å¯¹åº”çš„ç½‘ç»œè¯·æ±‚çš„hudå…¨éƒ¨å°è£…åˆ°è¯·æ±‚é‡Œé¢ã€‚

è¿™ä¸ªæ˜¯é’ˆå¯¹äºå¤§å¤šæ•°è¯·æ±‚ã€‚ä¸ªåˆ«å±•ç¤ºæ•ˆæœä¸åŒçš„è¯·æ±‚è‡ªå·±è€è€å®å®ç”¨provider.requestå†™å°±è¡Œã€‚
ä¸‹é¢æˆ‘ä»¬åœ¨NetworkManager.swiftä¸­è¿›è¡ŒäºŒæ¬¡å°è£…

```swift
///å…ˆæ·»åŠ ä¸€ä¸ªé—­åŒ…ç”¨äºæˆåŠŸæ—¶åå°è¿”å›æ•°æ®çš„å›è°ƒ
typealias successCallback = ((String) -> (Void))
///å†æ¬¡ç”¨ä¸€ä¸ªæ–¹æ³•å°è£…provider.request()
func NetWorkRequest(_ target: API, completion: @escaping successCallback ){
    //å…ˆåˆ¤æ–­ç½‘ç»œæ˜¯å¦æœ‰é“¾æ¥ æ²¡æœ‰çš„è¯ç›´æ¥è¿”å›--ä»£ç ç•¥
    
    //æ˜¾ç¤ºhud
    Provider.request(target) { (result) in
        //éšè—hud
        switch result {
        case let .success(response):
            do {
                //è¿™é‡Œè½¬JSONç”¨çš„swiftyJSONæ¡†æ¶
                let jsonData = try JSON(data: response.data)
                //åˆ¤æ–­åå°è¿”å›çš„codeç æ²¡é—®é¢˜å°±æŠŠæ•°æ®é—­åŒ…è¿”å› ï¼Œæˆ‘ä»¬åå°æ˜¯0000 ä»¥å®é™…åå°çº¦å®šä¸ºå‡†ã€‚            
                if jsonData[RESULT_CODE].stringValue == "0000"{
                    completion(String(data: response.data, encoding: String.Encoding.utf8)!)
                }else{
                    //flag ä¸ä¸º0000 HUDæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    print("flagä¸ä¸º0000 HUDæ˜¾ç¤ºåå°è¿”å›message"+"\(jsonData[RESULT_MESSAGE].stringValue)")
                }
            } catch {
            }
        case let .failure(error):
            guard let error = error as? CustomStringConvertible else {
                //ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæç¤ºç”¨æˆ·
                print("ç½‘ç»œè¿æ¥å¤±è´¥")
                break
            }
        }
    }
}
```

### MoyaConfig.swift è¿™ä¸ªå°±æ˜¯æ”¾ä¸€äº›å…¬ç”¨å­—ç¬¦ä¸²
 è§‰å¾—éº»çƒ¦å¯ä»¥æ”¾åœ¨NetworkManager.swiftä¸­  çœ‹ä¸ªäººçˆ±å¥½
ä»£ç å¦‚ä¸‹

```swift

import Foundation
/// å®šä¹‰åŸºç¡€åŸŸå
let Moya_baseURL = "http://news-at.zhihu.com/api/"

/// å®šä¹‰è¿”å›çš„JSONæ•°æ®å­—æ®µ
let RESULT_CODE = "flag"      //çŠ¶æ€ç 
let RESULT_MESSAGE = "message"  //é”™è¯¯æ¶ˆæ¯æç¤º

```

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†å»ç”¨å°è£…å¥½çš„ç½‘ç»œå·¥å…·ä¼˜é›…çš„è¿›è¡Œç½‘ç»œè¯·æ±‚

```swift
   NetWorkRequest(.testApi) { (response) -> (Void) in
          //ç”¨HandyJSONå¯¹è¿”å›çš„æ•°æ®è¿›è¡Œå¤„ç†
        }
```

------------- 2019.11.24  update â†“  -----------

ä¸¤å¹´å‰æˆ‘å†™äº†è¿™ç¯‡å…³äºMoyaç½‘ç»œæ¡†æ¶çš„å°è£…çš„æ–‡ç« ï¼Œ

ä¸Šé¢çš„å°è£…æ€è·¯çš„åŸåˆ™æ˜¯èƒ½å°‘å†™ä»£ç å°±å°‘å†™ä»£ç ã€‚æ‡’äººä¸“ç”¨ã€‚

éšç€ä¸šåŠ¡çš„å‘å±•  API æ–‡ä»¶ä¸­çš„switch case æ–‡ä»¶è¶Šæ¥è¶Šå¤šã€‚ å…¶å®ä¸ªäººæ„Ÿè§‰ç»´æŠ¤èµ·æ¥å…¶å®ä¹Ÿè¿˜å¥½ã€‚  

æœ€è¿‘æ‰“ç®—å†æ¬¡ä¼˜åŒ–ï¼ŒæŠŠä¸åŒæ¨¡å—çš„APIå°è£…åˆ°ä¸åŒçš„ æšä¸¾enum ä¸­ï¼Œ
è¿™ä¸ªæ—¶å€™é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜  å°±æ˜¯```ä¸Šé¢çš„Provideråªèƒ½ç”¨äºAPIè¿™ä¸ªæšä¸¾ä½“çš„æ•°æ®```ã€‚

å¦‚æœè¦æ–°å†™æ–°çš„æšä¸¾ä½“ï¼Œè¦å°è£…ä¸€å¥—æ–°çš„Provideräº†ã€‚   åæ¥æŸ¥çœ‹äº†ä¸€äº›å›½å¤–å¼€å‘è€…å¯¹Moyaçš„å°è£…ã€‚  æœ‰ä¸€éƒ¨åˆ†æ˜¯æŠŠä¸åŒæ¨¡å—çš„APIå°è£…åˆ°ä¸åŒçš„æšä¸¾ä¸­å»ç»´æŠ¤ã€‚  ç„¶åé’ˆå¯¹äºä¸åŒçš„æ¨¡å—å»åˆ›å»ºProviderç±»ï¼Œå¹¶å†…éƒ¨å¯¹Provider åšå…·ä½“çš„å®ç°ã€‚

ä½¿ç”¨çš„æ—¶å€™ ä½¿ç”¨å…·ä½“çš„Providerç±»çš„å®ä¾‹å»åšç½‘ç»œè¯·æ±‚ã€‚ 

è¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥åˆ†å¼€ç®¡ç†ä¸åŒçš„æ¨¡å—(å…¶å®Moyaçš„åˆè¡·å°±æ˜¯å–æŠ½ç¦»ç½‘ç»œè¯·æ±‚å’Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œ å·²ç»æœ‰ä¸€ç‚¹è§£è€¦çš„æ„æ€äº†)ã€‚ åå¤„å°±æ˜¯ä»£ç é‡ä¼šç¨å¾®å¤šä¸€äº›ã€‚

å…·ä½“çš„ä»£ç å®ç°æˆ‘ä¹Ÿå†™äº†Demoæ”¾åœ¨çš„é¡¹ç›®é‡Œé¢ã€‚

çœŸæ­£å–œæ¬¢ç”¨å“ªä¸ªå°±çœ‹ä¸ªäººéœ€æ±‚äº†~

